ğŸ“ my-gitops-repo/
â”œâ”€â”€ clusters/
â”‚   â”œâ”€â”€ dev/
â”‚   â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â”‚   â”œâ”€â”€ helmrelease.yaml
â”‚   â”‚   â””â”€â”€ values-configmap.yaml
â”‚   â””â”€â”€ prod/
â”‚       â”œâ”€â”€ kustomization.yaml
â”‚       â”œâ”€â”€ helmrelease.yaml
â”‚       â””â”€â”€ values-configmap.yaml
â”œâ”€â”€ apps/
â”‚   â””â”€â”€ myapp-helm/
â”‚       â”œâ”€â”€ charts/
â”‚       â”‚   â””â”€â”€ myapp/
â”‚       â”‚       â”œâ”€â”€ Chart.yaml
â”‚       â”‚       â”œâ”€â”€ templates/
â”‚       â”‚       â”‚   â”œâ”€â”€ deployment.yaml
â”‚       â”‚       â”‚   â””â”€â”€ service.yaml
â”‚       â”‚       â””â”€â”€ values.yaml
â””â”€â”€ flux-system/
    â””â”€â”€ source.yaml


1ï¸âƒ£ GitRepository â€“ Source for the Helm Chart
# flux-system/source.yaml
apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: GitRepository
metadata:
  name: myapp-repo
  namespace: flux-system
spec:
  interval: 1m
  url: https://github.com/my-org/my-gitops-repo
  ref:
    branch: main
  ignore: |
    # Only sync app charts and clusters
    !/apps/
    !/clusters/

2ï¸âƒ£ Helm Chart Default Values
# apps/myapp-helm/charts/myapp/values.yaml
replicaCount: 2
image:
  repository: nginx
  tag: latest


3ï¸âƒ£ Environment Override ConfigMaps
# clusters/dev/values-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: myapp-values
  namespace: dev
data:
  values.yaml: |
    image:
      tag: dev-1.0


# clusters/prod/values-configmap.yaml      
apiVersion: v1
kind: ConfigMap
metadata:
  name: myapp-values
  namespace: prod
data:
  values.yaml: |
    replicaCount: 3
    image:
      tag: stable-1.0


4ï¸âƒ£ HelmRelease per Environment

# clusters/dev/helmrelease.yaml
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: myapp
  namespace: dev
spec:
  releaseName: myapp-dev
  interval: 5m
  chart:
    spec:
      chart: apps/myapp-helm/charts/myapp
      sourceRef:
        kind: GitRepository
        name: myapp-repo
        namespace: flux-system
  valuesFrom:
    - kind: ConfigMap
      name: myapp-values
      valuesKey: values.yaml

# clusters/prod/helmrelease.yaml
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: myapp
  namespace: prod
spec:
  releaseName: myapp-prod
  interval: 5m
  chart:
    spec:
      chart: apps/myapp-helm/charts/myapp
      sourceRef:
        kind: GitRepository
        name: myapp-repo
        namespace: flux-system
  valuesFrom:
    - kind: ConfigMap
      name: myapp-values
      valuesKey: values.yaml

5ï¸âƒ£ Kustomization per Environment

# clusters/dev/kustomization.yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: myapp-dev
  namespace: flux-system
spec:
  interval: 5m
  path: ./clusters/dev
  prune: true
  sourceRef:
    kind: GitRepository
    name: myapp-repo
  targetNamespace: dev

# clusters/prod/kustomization.yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: myapp-prod
  namespace: flux-system
spec:
  interval: 5m
  path: ./clusters/prod
  prune: true
  sourceRef:
    kind: GitRepository
    name: myapp-repo
  targetNamespace: prod

âœ… Result
Flux syncs the GitRepository

Each environment has its own HelmRelease with separate override values

The same Helm chart is deployed twice with environment-specific values

ğŸ§  Optional Improvements
Use Secret + valuesFrom for sensitive env-specific values

Use HelmRelease.spec.valuesFiles for referencing a committed values.yaml file

Use kustomize overlays if you want stronger config composition

